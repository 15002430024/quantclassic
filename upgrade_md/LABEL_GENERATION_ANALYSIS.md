# æ ‡ç­¾ç”Ÿæˆé…ç½®åˆ†æ - Shift ä¸æœªæ¥é¢„æµ‹

## ğŸ“‹ ç›®å½•
1. [notebookä¸­çš„æ ‡ç­¾ç”Ÿæˆé…ç½®](#notebookä¸­çš„æ ‡ç­¾ç”Ÿæˆé…ç½®)
2. [quantclassicä¸­çš„Shiftæœºåˆ¶](#quantclassicä¸­çš„shiftæœºåˆ¶)
3. [é¢„æµ‹æµç¨‹å›¾](#é¢„æµ‹æµç¨‹å›¾)
4. [é…ç½®æ”¹è¿›å»ºè®®](#é…ç½®æ”¹è¿›å»ºè®®)

---

## notebookä¸­çš„æ ‡ç­¾ç”Ÿæˆé…ç½®

### ä½ç½®
åœ¨ **å•å…ƒæ ¼6ï¼ˆæ•°æ®é¢„å¤„ç†é…ç½®ï¼‰** ä¸­ï¼š

```python
# æ­¥éª¤3: ç”Ÿæˆæ ‡ç­¾æ•°æ®ï¼ˆè‡ªåŠ¨ç”Ÿæˆ ret_10dï¼‰
# æ³¨æ„ï¼šLabelGenerator ä¼šåœ¨ DataPreprocessor.fit_transform ä¸­è‡ªåŠ¨è°ƒç”¨
print("  æ­¥éª¤3: è‡ªåŠ¨ç”Ÿæˆæ ‡ç­¾æ•°æ®ï¼ˆret_10dï¼‰")
print("    æ ‡ç­¾å°†åœ¨é¢„å¤„ç†å™¨ä¸­è‡ªåŠ¨ç”Ÿæˆ")
```

### é—®é¢˜
å½“å‰é…ç½®ä¸­**æ²¡æœ‰æ˜¾å¼é…ç½®æ ‡ç­¾ç”Ÿæˆ**ï¼Œè€Œæ˜¯ä¾èµ–ï¼š
1. `DataPreprocessor.fit_transform()` è‡ªåŠ¨æ£€æµ‹ `SIMSTOCK_LABEL_NEUTRALIZE` æ­¥éª¤
2. è‡ªåŠ¨è°ƒç”¨ `LabelGenerator` ç”Ÿæˆ `ret_1d`ï¼ˆåªç”Ÿæˆ1å¤©æœŸï¼‰

è¿™å¯èƒ½ä¸ç¬¦åˆæ‚¨çš„éœ€æ±‚ï¼ˆ`ret_10d` åœ¨é…ç½®æ³¨é‡Šä¸­ä½†æœªå®ç°ï¼‰ã€‚

---

## quantclassicä¸­çš„Shiftæœºåˆ¶

### âœ… æœ‰Shift - ç”¨äºé¢„æµ‹æœªæ¥

åœ¨ `label_generator.py` çš„ `_generate_return_labels()` ä¸­ï¼ˆç¬¬123-132è¡Œï¼‰ï¼š

```python
# å…³é”®ä»£ç  - shift(-period) å®ç°å‘æœªæ¥ç§»åŠ¨
for period in self.config.return_periods:
    col_name = f'{label_name}_{period}d'
    
    if self.config.return_method == 'simple':
        # shift(-period) å‘åç§» period è¡Œï¼Œå®ç°è·å–æœªæ¥ä»·æ ¼
        df[col_name] = df.groupby(self.config.stock_col)[self.config.price_col].shift(-period)
        # è®¡ç®—æ”¶ç›Šç‡: (æœªæ¥ä»·æ ¼ - å½“å‰ä»·æ ¼) / å½“å‰ä»·æ ¼
        df[col_name] = (df[col_name] - df[self.config.price_col]) / df[self.config.price_col]
```

### ğŸ“Š Shiftæœºåˆ¶è¯¦è§£

```
shift(-1) çš„ä½œç”¨ç¤ºæ„ï¼š
=====================================
åŸå§‹æ•°æ® (æŒ‰æ—¶é—´é¡ºåº):
  æ—¥æœŸ    ä»·æ ¼    æ”¶ç›˜ä»·åˆ—
  2024-01-01  10.0
  2024-01-02  10.5
  2024-01-03  11.0    â† å½“å‰è¡Œ
  2024-01-04  11.5
  2024-01-05  12.0

shift(-1) å (å‘åæ‹‰ä¸€è¡Œï¼Œè´Ÿå·è¡¨ç¤ºæœªæ¥):
  æ—¥æœŸ    ä»·æ ¼    shift(-1)çš„å€¼
  2024-01-01  10.0   10.5  â† 2024-01-02çš„ä»·æ ¼
  2024-01-02  10.5   11.0  â† 2024-01-03çš„ä»·æ ¼
  2024-01-03  11.0   11.5  â† 2024-01-04çš„ä»·æ ¼ï¼ˆæœªæ¥ä»·æ ¼ï¼‰
  2024-01-04  11.5   12.0
  2024-01-05  12.0   NaN   â† æ— æœªæ¥ä»·æ ¼ï¼ˆæ•°æ®æœ«å°¾ï¼‰

è®¡ç®—æ”¶ç›Šç‡:
  ret_1d = (11.5 - 11.0) / 11.0 = 0.0455 (4.55%)
  è¿™æ˜¯ä»2024-01-03é¢„æµ‹çš„1å¤©åæ”¶ç›Šç‡
```

### ğŸ”‘ å…³é”®ç‚¹

| å‚æ•° | å«ä¹‰ | ç¤ºä¾‹ |
|------|------|------|
| `shift(-1)` | è·å–1å¤©åä»·æ ¼ | `ret_1d` |
| `shift(-5)` | è·å–5å¤©åä»·æ ¼ | `ret_5d` |
| `shift(-10)` | è·å–10å¤©åä»·æ ¼ | `ret_10d` |
| æœ€åNè¡Œ | å˜æˆNaNï¼ˆæ— æœªæ¥æ•°æ®ï¼‰ | éœ€è¦dropnaå¤„ç† |

---

## é¢„æµ‹æµç¨‹å›¾

```
æ•°æ®è¾“å…¥ (æ—¶é—´åºåˆ—)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å»æå€¼ (Winsorize)               â”‚ æ‰€æœ‰ç‰¹å¾
â”‚    - æˆªæ–­ä¸Šä¸‹2.5%                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æˆªé¢æ ‡å‡†åŒ– (Z-Score)             â”‚ æ‰€æœ‰ç‰¹å¾
â”‚    - æ¯æ—¥å¯¹æ‰€æœ‰è‚¡ç¥¨æ ‡å‡†åŒ–             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ç”Ÿæˆæ ‡ç­¾ (LabelGenerator)         â”‚ â­ å…³é”®æ­¥éª¤
â”‚    - shift(-1) è·å– 1 å¤©åä»·æ ¼       â”‚
â”‚    - è®¡ç®—æœªæ¥æ”¶ç›Šç‡                   â”‚
â”‚    - ç”Ÿæˆ ret_1d åˆ—                  â”‚
â”‚    æœ€å1è¡Œæ— æ ‡ç­¾ï¼ˆæ— æœªæ¥æ•°æ®ï¼‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ç‰¹å¾å¸‚å€¼è¡Œä¸šä¸­æ€§åŒ– (OLS)          â”‚ ç‰¹å¾å¤„ç†
â”‚    - ç§»é™¤è¡Œä¸šå’Œå¸‚å€¼å½±å“               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æ ‡ç­¾SimStockä¸­æ€§åŒ–                â”‚ â­ æ ‡ç­¾å·¥ç¨‹
â”‚    - ä½¿ç”¨ ret_1d ä½œä¸ºè¾“å…¥             â”‚
â”‚    - åˆ©ç”¨è‚¡ç¥¨é—´è¿”å›ç›¸å…³æ€§             â”‚
â”‚    - ç”Ÿæˆ alpha_label                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ç¼ºå¤±å€¼å¡«å……                        â”‚ å…œåº•å¤„ç†
â”‚    - ä½¿ç”¨ä¸­ä½æ•°å¡«å……                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ç‰¹å¾å¤„ç†å®Œæˆ (å¯ç”¨äºæ¨¡å‹è®­ç»ƒ)
    â†“
    â†“ (æ—¶é—´çª—å£å¤„ç†ï¼šwindow_size=40)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GRU/LSTM æ¨¡å‹                       â”‚
â”‚ è¾“å…¥: [ç‰¹å¾ Ã— 40æ­¥]                 â”‚
â”‚ è¾“å‡º: é¢„æµ‹ä¸‹ä¸€æ­¥æ”¶ç›Š                 â”‚
â”‚ ç›®æ ‡: alpha_label (å·²ä¸­æ€§åŒ–)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é…ç½®æ”¹è¿›å»ºè®®

### âŒ å½“å‰é—®é¢˜

1. **æ ‡ç­¾é…ç½®ä¸æ˜ç¡®**
   ```python
   # è¿™å¥è¯æ˜¯æ³¨é‡Šï¼Œæ²¡æœ‰å®é™…é…ç½®
   print("  æ­¥éª¤3: è‡ªåŠ¨ç”Ÿæˆæ ‡ç­¾æ•°æ®ï¼ˆret_10dï¼‰")
   ```

2. **è‡ªåŠ¨ç”Ÿæˆåªåˆ›å»º ret_1d**
   - åœ¨ `data_preprocessor.py` ä¸­ç¡¬ç¼–ç  `return_periods=[1]`
   - æ— æ³•ç”Ÿæˆå¤šå‘¨æœŸæ ‡ç­¾ï¼ˆå¦‚ ret_5d, ret_10dï¼‰

3. **SimStockä¸­æ€§åŒ–é…ç½®ä¸æ ‡ç­¾å‘¨æœŸä¸åŒ¹é…**
   ```python
   params={
       'label_column': 'ret_1d',  # ç¡¬ç¼–ç 1d
       'output_column': 'alpha_label',
   }
   ```

### âœ… æ”¹è¿›æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1: æ˜¾å¼é…ç½®æ ‡ç­¾ç”Ÿæˆå™¨

åœ¨å•å…ƒæ ¼6ä¸­æ·»åŠ æ˜¾å¼çš„æ ‡ç­¾é…ç½®æ­¥éª¤ï¼š

```python
from quantclassic.data_processor.label_generator import LabelConfig, LabelGenerator

# åˆ›å»ºæ ‡ç­¾é…ç½®ï¼ˆåœ¨é¢„å¤„ç†å‰ï¼‰
print("  æ­¥éª¤3: é…ç½®æ ‡ç­¾ç”Ÿæˆ")
label_config = LabelConfig(
    stock_col='order_book_id',
    time_col='trade_date',
    price_col='close',
    label_type='return',
    return_periods=[1, 5, 10, 20],  # å¤šå‘¨æœŸæ”¶ç›Šç‡
    return_method='simple',
    neutralize=False  # åœ¨ä¸­æ€§åŒ–æ­¥éª¤ä¸­å¤„ç†
)

# åœ¨é¢„å¤„ç†å‰ç”Ÿæˆæ ‡ç­¾
label_gen = LabelGenerator(label_config)
df_raw = label_gen.generate_labels(df_raw, label_name='ret')
# ç°åœ¨df_rawåŒ…å«: ret_1d, ret_5d, ret_10d, ret_20d

print(f"âœ… ç”Ÿæˆæ ‡ç­¾åˆ—: {[col for col in df_raw.columns if col.startswith('ret_')]}")
```

#### æ–¹æ¡ˆ2: åœ¨é¢„å¤„ç†é…ç½®ä¸­æŒ‡å®šæ ‡ç­¾å‘¨æœŸ

ä¿®æ”¹ `data_preprocessor.py` çš„è‡ªåŠ¨ç”Ÿæˆé€»è¾‘ï¼š

```python
# åœ¨ DataPreprocessor.fit_transform() ä¸­
# ä¿®æ”¹è¿™ä¸€è¡Œï¼ˆå½“å‰ç¬¬85-90è¡Œï¼‰ï¼š

# å½“å‰ï¼ˆåªç”Ÿæˆ1dï¼‰:
lg_config = LabelConfig(
    return_periods=[1],  # âŒ ç¡¬ç¼–ç 
    return_method='simple'
)

# æ”¹ä¸ºè¯»å–é…ç½®ï¼ˆæ›´çµæ´»ï¼‰:
lg_config = LabelConfig(
    stock_col=...,
    time_col=...,
    price_col='close',
    label_type='return',
    return_periods=self.config.neutralize_config.return_periods,  # ä»é…ç½®è¯»å–
    return_method='simple'
)
```

---

## å®æ–½å»ºè®®

### ç«‹å³å¯åšçš„æ”¹è¿›ï¼ˆå•å…ƒæ ¼6ï¼‰

```python
# =============================================================================
# æ­¥éª¤ 2B: æ”¹è¿›ç‰ˆæ•°æ®é¢„å¤„ç†é…ç½®
# =============================================================================

from quantclassic.data_processor.label_generator import LabelConfig, LabelGenerator
from quantclassic.data_processor.preprocess_config import PreprocessConfig, ProcessMethod

print("\nã€æ–°å¢ã€‘ç”Ÿæˆå¤šå‘¨æœŸæ”¶ç›Šç‡æ ‡ç­¾")
label_config = LabelConfig(
    stock_col='order_book_id',
    time_col='trade_date',
    price_col='close',
    label_type='return',
    return_periods=[1, 5, 10],  # 1æ—¥ã€5æ—¥ã€10æ—¥æœªæ¥æ”¶ç›Š â­ æœ‰shift(-n)
    return_method='simple'
)

label_gen = LabelGenerator(label_config)
df_raw = label_gen.generate_labels(df_raw, label_name='ret')

print(f"âœ… ç”Ÿæˆæ ‡ç­¾åˆ—:")
ret_cols = [col for col in df_raw.columns if col.startswith('ret_')]
for col in ret_cols:
    valid_count = df_raw[col].count()
    print(f"  {col}: {valid_count}/{len(df_raw)} æœ‰æ•ˆæ ·æœ¬ ({100*valid_count/len(df_raw):.1f}%)")

# æ³¨æ„ï¼šæœ€ånè¡Œæ— æ•ˆï¼ˆæ— æœªæ¥æ•°æ®ï¼‰
print(f"ğŸ’¡ æç¤º: æœ€å10è¡Œä¸ºNaNï¼ˆæ— æœªæ¥æ•°æ®ï¼‰ï¼Œè®­ç»ƒæ—¶ä¼šè‡ªåŠ¨è¿‡æ»¤")
```

### é¢„æœŸè¾“å‡º

```
âœ… ç”Ÿæˆæ ‡ç­¾åˆ—:
  ret_1d: 2999/3000 æœ‰æ•ˆæ ·æœ¬ (99.97%)    # æœ€å1è¡ŒNaN
  ret_5d: 2995/3000 æœ‰æ•ˆæ ·æœ¬ (99.83%)    # æœ€å5è¡ŒNaN
  ret_10d: 2990/3000 æœ‰æ•ˆæ ·æœ¬ (99.67%)   # æœ€å10è¡ŒNaN
```

---

## å…³é”®ä»£ç ä½ç½®

| æ–‡ä»¶ | è¡Œæ•° | è¯´æ˜ |
|------|------|------|
| `label_generator.py` | 100-140 | `_generate_return_labels()` - shift(-period)å®ç° |
| `label_generator.py` | 38-48 | `LabelConfig` - æ ‡ç­¾é…ç½®ç±» |
| `data_preprocessor.py` | 75-95 | è‡ªåŠ¨æ ‡ç­¾ç”Ÿæˆé€»è¾‘ |
| `vae.ipynb` å•å…ƒæ ¼6 | ~410-460 | å½“å‰é¢„å¤„ç†é…ç½® |

---

## æ€»ç»“

### âœ… æ˜¯å¦æœ‰Shift?
**æœ‰çš„ï¼** `shift(-period)` ç”¨æ¥è·å–æœªæ¥ä»·æ ¼ï¼Œå®ç°æ ‡ç­¾çš„å‰å‘çœ‹ã€‚

### ğŸ“ åœ¨å“ªé‡Œ?
- **quantclassic**: `data_processor/label_generator.py` ç¬¬128è¡Œ
- ```python
  df[col_name] = df.groupby(self.config.stock_col)[self.config.price_col].shift(-period)
  ```

### ğŸ¯ é¢„æµ‹åŸç†
1. `shift(-1)` è·å–1å¤©åä»·æ ¼ â†’ è®¡ç®— `ret_1d`ï¼ˆä¸‹1å¤©æ”¶ç›Šï¼‰
2. `shift(-5)` è·å–5å¤©åä»·æ ¼ â†’ è®¡ç®— `ret_5d`ï¼ˆä¸‹5å¤©æ”¶ç›Šï¼‰
3. æ¨¡å‹å­¦ä¹ å½“å‰ç‰¹å¾ â†’ é¢„æµ‹ä¸‹Nå¤©æ”¶ç›Šç‡ âœ“

### âš ï¸ å½“å‰ç¼ºé™·
- notebookå•å…ƒæ ¼6æ²¡æœ‰æ˜¾å¼é…ç½®æ ‡ç­¾å‘¨æœŸ
- è‡ªåŠ¨ç”Ÿæˆåªåˆ›å»º `ret_1d`
- åº”è¯¥æ”¯æŒå¤šå‘¨æœŸæ ‡ç­¾ï¼ˆret_1d/5d/10dï¼‰

### ğŸ’¡ æ”¹è¿›æ–¹å‘
åœ¨å•å…ƒæ ¼6æ·»åŠ æ˜¾å¼çš„ `LabelGenerator` é…ç½®ï¼Œæ”¯æŒå¤šå‘¨æœŸæ ‡ç­¾ç”Ÿæˆã€‚

