# REQ-002: 动态图训练行业列缺失告警排查与修复方案

**创建时间**: 2026-01-30 16:25  
**状态**: ✅ 已完成

---

## 1. 需求背景

用户在执行 `DataManager.create_rolling_daily_loaders_from_test()` / `create_rolling_daily_loaders()` 相关流程时，日志出现：

- `WARNING:IndustryGraphBuilder:未找到行业列 'industry_code'，返回仅自环邻接矩阵`

用户要求“找问题、中文写方案、不改代码”。

## 2. 问题分析

### 2.1 当前状态
- 动态图训练使用 `DailyBatchDataset + DailyGraphDataLoader`。
- `DailyGraphDataLoader.collate_daily` 在构建图时：
  - **相关性/混合图**：只构建 `stock_col + 特征列` 的 `df_day`（不包含行业列）。
  - **行业图**：依赖 `IndustryGraphBuilder` 的全局映射 `stock_industry_mapping` 或 `df_day` 行业列。
- 日志提示行业列缺失，说明 `IndustryGraphBuilder` 既未拿到行业列，也未拿到全局映射。

### 2.2 核心问题
- `DataManager._normalize_graph_builder_config` **只对 type='industry' 注入行业映射**，对 `type='hybrid'` 未注入 `stock_industry_mapping`。
- `collate_daily` 构造的 `df_day` 不包含 `industry_code` 列（仅 stock + 特征），因此 `IndustryGraphBuilder` 无法在当日数据中取到行业信息。
- 结果：行业图退化为“仅自环”，混合图实际上变成“纯相关性图”。

## 3. 解决方案

### 3.1 方案概述
为混合图/行业图确保行业映射来源：
- **优先方案**：在 `graph_builder_config` 中显式传入 `stock_industry_mapping`。
- **备选方案**：扩展 `_normalize_graph_builder_config`，对 `type in {'industry','hybrid'}` 统一注入行业映射。
- **临时绕过**：直接传入已构造好映射的 `HybridGraphBuilder` 实例。

### 3.2 实施步骤
1. **确认原始数据列**：保证 `raw_data` 中存在 `industry_code` 且与 `stock_col` 对齐。
2. **配置注入映射**：
   - 在 `graph_builder_config` 增加 `stock_industry_mapping` 字段。
3. **或扩展配置归一化逻辑**（推荐长期方案）：
   - 在 `_normalize_graph_builder_config` 中对 `type='hybrid'` 同样注入 `stock_industry_mapping`。
4. **验证**：重新运行滚动训练，确认日志不再出现“未找到行业列”。

## 4. 需要修改的文件

| 文件路径 | 修改类型 | 修改说明 |
|---------|---------|---------|
| `data_set/manager.py` | 修改 | `_normalize_graph_builder_config` 支持 `type='hybrid'` 注入 `stock_industry_mapping`。 |
| `notebook/lstm+attention12011427.ipynb` | 修改 | 在调用 `create_rolling_daily_loaders` 前为 `graph_builder_config` 显式传入 `stock_industry_mapping`。 |

## 5. 风险与注意事项

- 若 `industry_code` 数据缺失或与 `stock_col` 不一致，行业映射会不完整，导致邻接矩阵仍退化。
- 混合图权重 α 将失效或偏向相关性图，需确认是否符合预期实验设计。

## 6. 依赖关系

- **前置条件**：`raw_data` 中必须包含 `industry_code` 列，并且 `stock_col` 与其正确匹配。
- **关联需求**：无

---
*变更记录: 2026-01-30 初始创建*  
*变更记录: 2026-01-30 已实施修改，manager.py `_normalize_graph_builder_config` 对 `type in ('industry','hybrid')` 统一注入行业映射*
