# REQ-005: 动态图模型回测收益起始时间与标签校验

**创建时间**: 2026-02-06 15:40
**状态**: 已实施 ✅

---

## 1. 需求背景

在执行动态图模型的 Notebook 回测（Cell 14）时，用户报告以下异常：
1. **累计收益起始时间异常**: 回测数据理论覆盖 2010-2025 年，但观察到累计收益曲线似乎仅从 2023 年开始计算。
2. **标签校验**: 用户需要确认回测所使用的收益标签列（即预测目标）。
3. **代码逻辑检查**: 怀疑是否存在隐蔽的代码逻辑错误导致前回测窗口被忽略。

## 2. 问题分析

### 2.1 当前状态
*   **数据源**: `notebook/output/rolling_dynamic_cache/dynamic_predictions.parquet` 覆盖 2010-10-26 至 2025-12-11，无缺失行，`future_return` 列数据完整。
*   **回测逻辑**: 使用 `FactorBacktestSystem` (单因子模式) 或 `MultiFactorBacktest`。当前为单因子模式 (`factor_raw_std`)。
*   **日志**: IC 统计显示全样本分析（2010-2025）结果正常（IC~0.05）。

### 2.2 核心问题
经过代码审计，发现潜在的逻辑缺陷：
1.  **列名硬编码**: `backtest/backtest_system.py` 中的 `_merge_returns` 方法硬编码使用 `ts_code` 作为关联键，而系统标准列名为 `order_book_id`。
    *   虽然在当前场景下 `processed_df` 可能已包含收益列从而跳过此步骤，但这是一个高危 Bug。
2.  **数据完整性验证缺失**: 回测流程未显式输出“每日有效持仓股票数”或“组合净值表的首尾日期”，导致难以快速定位是数据过滤问题还是绘图问题。
3.  **绘图时间范围不透明**: 目前图表未显式打印用于绘图的数据时间范围，若数据在中间步骤被过滤，难以定位截断位置。

## 3. 解决方案

### 3.1 方案概述
1.  **修复回测系统 Bug**: 修正 `_merge_returns` 中的硬编码列名，使其使用标准化的 `order_book_id`。
2.  **增强 Notebook 诊断**: 在 Cell 14 中增加诊断代码，打印组合收益表的前5行和最后5行，以及每年的有效交易天数，直接验证回测结果的时间覆盖范围。
3.  **检查因子空值**: 排除因某些年份因子值为 NaN 导致的无法构建组合。
4.  **输出回测净值区间**: 明确回测输出的起止日期，避免“实际回测范围”与“预期数据范围”混淆。

### 3.2 实施步骤
1.  修改 `jupyterlab/quantclassic/backtest/backtest_system.py`:
    *   更新 `_merge_returns` 方法，将 `ts_code` 替换为 `order_book_id`（或动态传入参数）。
2.  修改 Notebook `lstm+attention12011427.ipynb` (Cell 14):
    *   添加 `dynamic_predictions` 数据范围与缺失统计输出。
    *   在回测结束后，打印 `backtest_results['portfolios']['long_short']` 的时间范围统计。

## 4. 需要修改的文件

| 文件路径 | 修改类型 | 修改说明 |
|---------|---------|---------|
| `jupyterlab/quantclassic/backtest/backtest_system.py` | 修改 | `_merge_returns` 修复 `ts_code` 硬编码为 `order_book_id` |
| `jupyterlab/quantclassic/notebook/lstm+attention12011427.ipynb` | 修改 | 增加回测输出时间范围与数据完整性诊断 |

## 5. 风险与注意事项

- **兼容性**: 确保 `data_df` 和 `factor_df` 在调用均已标准化 `stock_col`。
- **验证**: 修复后需重新运行回测，观察累计收益曲线是否恢复至 2010 年起始。

## 6. 依赖关系

- **前置条件**: 无
- **关联需求**: REQ-002 (离线回测支持)

---
*变更记录: 2026-02-06 初始创建*
*变更记录: 2026-02-06 实施完成 — 修复 `_merge_returns` 硬编码 + Cell 14 诊断增强*
