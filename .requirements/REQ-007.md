# REQ-007: 引入 GeneralBacktest 作为回测后端的迁移方案

**创建时间**: 2026-02-09 00:00  
**状态**: 待实施

---

## 1. 需求背景

用户认为 quantclassic 内置回测框架质量不佳，希望将同学的 GeneralBacktest 接入作为新的回测框架。GeneralBacktest 的核心输入为“每日调仓权重 + 日频价格数据”，而 quantclassic 当前回测链路基于因子分组/多空组合。用户希望明确：
- quantclassic 的未来预测与每日持仓在哪些模块实现
- 迁移到 GeneralBacktest 的可行方案与落地步骤

## 2. 问题分析

### 2.1 当前状态
- **预测输出位置**:
  - 训练/预测由 model 模块生成，常见输出位于 `model/train/rolling_window_trainer.py` / `model/train/rolling_daily_trainer.py` 的预测结果 DataFrame。
  - 回测侧的多因子预测适配在 `backtest/prediction_adapter.py`，将 `pred_factor_*` 集成为单因子列并做列名映射。
- **每日持仓生成位置**:
  - 当前回测持仓逻辑由 `backtest/portfolio_builder.py` 负责：`create_long_portfolio` / `create_short_portfolio` 按 `trade_date` 分组，基于因子排序选股，并按 `rebalance_freq` 选择调仓日形成“持有集合”。
  - 该模块输出的是每日组合收益与统计信息（`portfolio_return`, `n_stocks`, `avg_factor`），并未显式导出“每日权重明细”。
- **当前回测接口**:
  - `backtest/backtest_system.py` 负责整合因子生成、处理、IC、组合构建与绩效评估。

### 2.2 核心问题
- **接口不匹配**: GeneralBacktest 需要 `weights_data(date, code, weight)` 与 `price_data(date, code, open/close/adj_factor)`，而 quantclassic 回测链路输出的是“组合收益序列”，缺少可直接对接的“权重明细”。
- **权重生成缺失**: quantclassic 现有 `PortfolioBuilder` 仅生成每日收益，不输出调仓日或每日持仓权重。
- **价格数据来源**: GeneralBacktest 需要日频价格与复权因子字段，需确认 quantclassic 数据源是否完整覆盖，且列名映射明确。

## 3. 解决方案

### 3.1 方案概述
在 quantclassic 中新增“权重生成 + GeneralBacktest 适配层”，以最小侵入方式将现有预测/因子输出转换为 GeneralBacktest 所需的 `weights_data` 与 `price_data`，并允许在配置中切换回测引擎。

### 3.2 实施步骤
1. **环境准备与依赖收敛**
   - **首选方案**：指导用户以 editable 模式安装 (`pip install -e jupyterlab/github/GeneralBacktest`)。
   - **兜底方案**：仅在 `ImportError` 时尝试动态添加 `sys.path`，并打印“不推荐用于生产”的警告。
   - 在 `backtest/general_backtest_adapter.py` 中集中处理导入逻辑。

2. **定义数据契约（价格与权重）**
   - **权重表**：`date` (datetime64), `code` (str, 唯一键: date+code), `weight` (float, 调仓日总和=1.0)。
   - **价格表**：`date` (datetime64), `code` (str), `open`, `close`, `adj_factor`。
   - **时点对齐**：T日收盘后产生的信号，默认对应 T+1 日开盘买入（`buy_price='open'`）。
   - **缺省策略**：`adj_factor` 缺失默认为 1.0；缺失 `open` 用 `close` 填充；关键字段缺失必须报错。

3. **新增权重生成器**
   - 扩展 `PortfolioBuilder`，增加 `generate_weights` 方法：
     - **选股逻辑**：复用现有 Top/Bottom 或 Group 逻辑。
     - **权重计算**：
       - `Top (Long)`: 权重为正，总和 `long_ratio` (如 1.0)。
       - `Bottom (Short)`: 权重为负，总和 `-short_ratio` (如 -1.0)。
       - `Group`: 仅支持做多时，各组权重归一化为 1.0。
     - **特殊状态处理**：遇到停牌/缺失数据股票，权重置 0（默认）或按配置处理。
     - **持仓延续**：输出调仓日权重即可（GeneralBacktest 自动持有），无需填充中间日。

4. **适配 GeneralBacktest 调用**
   - 创建 `backtest/general_backtest_adapter.py`，实现 `run_general_backtest` 接口。
   - **参数映射**：
     - `buy_price` -> 默认为 `open`。
     - `sell_price` -> 默认为 `close` 或 `open`。
   - **可视化集成**：调用 `bt_instance.plot_all()`，结果保存至 `output_dir/plots/general_backtest/`。

5. **引擎切换与回滚策略**
   - 在 `BacktestConfig` 中新增 `engine` (默认 `quantclassic`)。
   - **回滚机制**：若 `engine='general_backtest'` 但初始化失败（如未安装包），自动降级回 `quantclassic` 并记录 Error 日志。
   - **兼容性**：确保使用旧配置字典的代码仍能正常运行。

6. **测试计划**
   - 详见第 8 节。

## 4. 需要修改的文件

| 文件路径 | 修改类型 | 修改说明 |
|---------|---------|---------|
| `backtest/portfolio_builder.py` | 修改 | 增加 `PortfolioBuilder.generate_weights()` 方法，输出符合 GeneralBacktest 格式的权重 DataFrame。 |
| `backtest/backtest_config.py` | 修改 | 增加 `engine`, `buy_price`, `sell_price` 字段以及 `general_backtest_options` 字典。 |
| `backtest/backtest_system.py` | 修改 | 增加回测引擎切换逻辑；处理 `adj_factor` 缺失时的默认值填充。 |
| `backtest/general_backtest_adapter.py` | 新增 | 封装 GeneralBacktest 调用、路径引入、参数映射与结果绘图。 |
| `backtest/prediction_adapter.py` | 修改 | (可选) 支持输出权重所需的列名规范优化。 |
| `README.md` / `backtest/README.md` | 修改 | 补充 GeneralBacktest 接入说明与示例。 |
| `ARCHITECTURE.md` | 修改 | 更新 backtest 模块架构说明，加入 GeneralBacktest 适配层描述。 |

## 5. 风险与注意事项

- **列名与字段缺失**: GeneralBacktest 需要 `open/close/adj_factor`，如果数据源不全需补齐或调整配置。
- **调仓频率语义**: quantclassic 的 `rebalance_freq` 与 GeneralBacktest 的“调仓日权重表”需要明确等价关系。
- **权重归一化**: GeneralBacktest 会对权重归一化，但仍需保证权重和接近 1 且无重复资产。
- **交易成本与滑点**: 需要在配置层明确默认值，否则结果不可比。

## 6. 依赖关系

- **前置条件**:
  - 明确 GeneralBacktest 需要的价格字段来源与列名映射。
  - 明确回测权重生成规则（多空/分组/全多/中性）。
- **关联需求**: 无

## 7. 验收标准

### 7.1 权重表完整性
- **必须**：每个调仓日的权重绝对值之和应等于 `long_ratio + short_ratio`（允许 1e-6 误差）。
- **必须**：同一调仓日、同一 code 不可出现多行。
- **必须**：权重表中不包含 `NaN` 或 `Inf`。

### 7.2 回测输出完整性
- **必须**：若 `engine='general_backtest'`，必须生成 `nav_series`, `positions`, `trade_records`。
- **必须**：`trade_records` 中的交易日期必须在输入数据的日期范围内。

### 7.3 口径对比
- 在无交易成本和滑点的情况下，两套引擎的年化收益率差异应 < 5.0%（差异主要来自 GeneralBacktest 的次日成交 vs 现有当日成交逻辑）。
- 若差异显著，需输出详细的对账单（首个差异日、权重差异、价格差异）。

### 7.4 异常处理
- **必须报错**：输入权重为空。
- **必须报错**：价格数据日期与权重日期无交集。
- **必须报错**：缺少关键列（open, close, adj_factor）且无法从其他列推导。

## 8. 测试计划

### 8.1 单元测试
- Test: `PortfolioBuilder.generate_weights` - 验证多空/分组模式下的权重和符号。
- Test: `GeneralBacktestAdapter.adapt_data` - 验证列名映射和缺省值填充。

### 8.2 集成测试
- Case: `test_engine_switching` - 动态切换 `engine` 参数，验证调用链路是否正确。
- Case: `test_fallback` - 模拟 `GeneralBacktest` 未安装场景，验证是否自动降级并报警。

### 8.3 回归测试
- 运行 `examples/lstm_basic.yaml`，确保默认配置下结果与变更前一致（bit-exact 或极小误差）。

---
*变更记录: 2026-02-09 初始创建*
*变更记录: 2026-02-09 补充实施细节、验收标准与测试计划*
