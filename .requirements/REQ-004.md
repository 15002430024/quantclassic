# REQ-004: 滚动窗口 IC 计算逻辑修正（因子聚合方式与评估口径对齐）

**创建时间**: 2026-02-06 15:00  
**状态**: 待实施

---

## 1. 需求背景

步骤 3-DYNAMIC 完成 15 窗口训练后，当前 notebook 计算出的窗口 IC 整体偏弱且多为负值。  
经复核，主要存在三个口径偏差：

1. 多因子预测仅使用了第 0 维（`pred[:, 0]`）。
2. notebook 的窗口 IC 使用了 Pearson（`Series.corr` 默认）。
3. notebook 的窗口 IC 使用训练标签 `label`（来自 `alpha_label` 的 rank 处理链），而非原始未来收益 `y_ret_10d`。

## 2. 已确认现状（基于当前实现）

### 2.1 因子聚合现状

`model/train/rolling_daily_trainer.py` 的 `_predict_daily_window` 对 `(N, 64)` 输出会报警并取首列：

```python
pred = pred[:, 0]
```

日志也持续出现：

> `检测到多因子预测输出 shape=(..., 64)，取首列用于评估。`

### 2.2 notebook IC 现状

步骤 3-DYNAMIC 单元的窗口 IC 计算为：

```python
window_ic = pred_df.groupby('trade_date').apply(
    lambda x: x['pred'].corr(x['label']), include_groups=False
).mean()
```

这等价于「每日截面 Pearson + 使用 `label` 列」。

### 2.3 回测组件现状

`BacktestConfig.ic_method` 默认已是 `'spearman'`，`ic_analyzer.py` 也支持 Spearman。  
因此问题主要在 notebook 手工统计口径与推理侧聚合方式，不在回测框架能力。

## 3. 目标口径（本需求落地后）

1. **因子聚合**：64 维输出按样本取均值，`pred.mean(axis=1)`。
2. **IC 方法**：Spearman（标准 Rank IC）。
3. **收益列**：原始未来收益 `y_ret_10d`（在步骤 5 合并后命名为 `future_return`）。
4. **统计粒度**：每日截面 IC，再按时间均值汇总窗口 IC。

## 4. 解决方案

### 4.1 必做步骤

#### 步骤 1：修正推理侧多因子聚合

修改 `model/train/rolling_daily_trainer.py` `_predict_daily_window`：

```python
# 修复前
pred = pred[:, 0]

# 修复后
pred = pred.mean(axis=1)
```

这样与 `simple_trainer.py` 训练/验证阶段的 `pred.mean(dim=1)` 保持一致。

#### 步骤 2：窗口 IC 统一改为 Spearman + `future_return`

建议把窗口 IC 统计放在步骤 5 合并 `future_return` 之后，避免重复大表 merge。  
新增一个安全计算函数，处理样本不足和常数截面：

```python
from scipy.stats import spearmanr

def safe_rank_ic(group, factor_col='pred', return_col='future_return'):
    valid = group[[factor_col, return_col]].dropna()
    if len(valid) < 10:
        return np.nan
    if valid[factor_col].nunique() < 2 or valid[return_col].nunique() < 2:
        return np.nan
    res = spearmanr(valid[factor_col], valid[return_col])
    return float(res.statistic) if hasattr(res, 'statistic') else float(res[0])
```

按窗口统计：

```python
test_ics = []
for wid, wdf in all_predictions_df.groupby('window_idx'):
    daily_ic = wdf.groupby('trade_date', group_keys=False).apply(safe_rank_ic)
    window_ic = daily_ic.mean()
    if pd.notna(window_ic):
        test_ics.append(window_ic)
        print(f"   窗口 {int(wid)} Rank IC: {window_ic:.4f}")
```

#### 步骤 3：显式确认 notebook 回测参数

`backtest_config.py` 默认值无需修改。  
仅需确认 notebook 中 `BacktestConfig(**backtest_options)` 的 `backtest_options` 未把 `ic_method` 覆盖为 `'pearson'`。

### 4.2 与 REQ-003 的执行顺序

1. 先按 `REQ-003` 解决步骤 5 的 OOM 风险，确保单元可稳定跑完。
2. 再按本需求修正 IC 口径并复核统计结果。

## 5. 需要修改的文件

| 文件路径 | 修改类型 | 修改说明 |
|---------|---------|---------|
| `model/train/rolling_daily_trainer.py` | 修改 | `_predict_daily_window` 中多因子聚合由 `pred[:, 0]` 改为 `pred.mean(axis=1)` |
| `notebook/lstm+attention12011427.ipynb`（步骤 3-DYNAMIC 单元） | 修改 | 窗口 IC 改为 Spearman，收益列改为 `future_return`，增加 `safe_rank_ic` 边界处理 |

## 6. 验收标准

1. 训练日志中不再出现“取首列用于评估”的警告。
2. 窗口 IC 计算逻辑明确为 Spearman，且输入列为 `pred` 与 `future_return`。
3. `test_ics` 可稳定产出（常数截面可返回 NaN 并被跳过，不导致异常中断）。
4. Notebook 回测流程可复用同一份 `future_return` 数据，不额外引入大规模重复 merge。

## 7. 风险与注意事项

- 多因子均值聚合默认各输出维度同权；若未来需要差异化权重，应单独立项。
- Spearman 在某些交易日可能因截面常数返回 NaN，这属于预期统计行为。
- 训练标签与评估标签不一致（训练用 `alpha_label` 链路，评估用原始收益）是有意设计，不是 bug。
- 本需求不扩展为“保留 64 列逐因子回测”；该方案会显著增加内存占用，建议后续独立评估。

## 8. 依赖关系

- **前置条件**：`REQ-003` 的 OOM 风险至少完成 notebook 级缓解。
- **关联需求**：`REQ-001`（训练侧已采用 `mean(dim=1)` 聚合）。

---
*变更记录: 2026-02-06 初始创建*  
*变更记录: 2026-02-06 复核后更新：收敛到 Spearman + future_return + mean 聚合，并补齐边界处理与执行顺序*
