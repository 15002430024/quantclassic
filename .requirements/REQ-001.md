# REQ-001: 滚动日级训练张量维度不匹配排查与修复方案

**创建时间**: 2026-01-30 16:05  
**状态**: ✅ 已完成

---

## 1. 需求背景

用户在 Jupyter 单元格中调用 `RollingDailyTrainer.train(...)` 进行滚动训练时触发运行时错误：

- `RuntimeError: The size of tensor a (64) must match the size of tensor b (1121) at non-singleton dimension 1`

该错误发生于 `SimpleTrainer.train_batch` 计算损失时。通过分析 Traceback 和 Notebook 上下文，确认模型配置中 `output_dim=64`（输出 64 个因子），而标签 `y` 为一维 `[N]`。

## 2. 问题分析

### 2.1 当前状态
- **模型输出**：`HybridGraphModel` 配置了 `output_dim=64`，前向传播输出 `pred` 形状为 `[N, 64]`。
- **标签数据**：`DailyGraphDataLoader` 提供单维度标签 `y`，形状为 `[N]`。
- **验证逻辑**：`SimpleTrainer.validate_epoch` 中已包含对多维输出的聚合处理（`pred = pred.mean(dim=1)`），因此验证阶段未报错。
- **训练逻辑**：`SimpleTrainer.train_batch` **缺失**同样的聚合处理，直接将 `[N, 64]` 的 `pred` 与 `[N]` 的 `y` 传入损失函数，导致广播失败。

### 2.2 核心问题
`SimpleTrainer.train_batch` 与 `validate_epoch` 处理逻辑不一致，未能处理多因子输出（`output_dim > 1`）与单目标标签（`dim=1`）的训练场景。

## 3. 解决方案

### 3.1 方案概述
在 `SimpleTrainer.train_batch` 中补充与 validation 阶段一致的降维/聚合逻辑。当检测到模型输出为多维且与标签维度不匹配时，自动对输出维度取均值。

### 3.2 实施步骤
1. 修改 `model/train/simple_trainer.py` 的 `train_batch` 方法。
2. 在计算 Loss 前，增加如下逻辑：
   - 检查 `pred` 是否为 2D 且列数 > 1。
   - 检查 `y` 是否为 1D（或列数为 1）。
   - 若满足，执行 `pred = pred.mean(dim=1)`。
3. （可选）确认 `model_config` 中的 `output_dim=64` 是否为预期设置。如果是预期行为（多因子集成），则上述聚合训练是合理的基准策略。

## 4. 需要修改的文件

| 文件路径 | 修改类型 | 修改说明 |
|---------|---------|---------|
| `model/train/simple_trainer.py` | 修改 | 在 `train_batch` 中增加 `pred.mean(dim=1)` 聚合逻辑，修复维度不匹配问题。 |

## 5. 风险与注意事项

- **聚合方式**：取均值（mean）假设 64 个因子都是对同一目标的预测。如果这 64 个维度代表不同含义（如分类概率或正交因子），简单取均值可能不妥，但鉴于 `validate_epoch` 已经这样做，保持训练一致是首选修复。
- **梯度影响**：聚合操作是可导的，梯度会平均回传给 64 个输出节点。

## 6. 依赖关系

- **前置条件**：无
- **关联需求**：无

---
*变更记录: 2026-01-30 更新分析，精确定位到 SimpleTrainer 训练代码缺失聚合逻辑*
