# QuantClassic VAE é«˜çº§é…ç½®æ¨¡æ¿
# å±•ç¤ºå¦‚ä½•è‡ªå®šä¹‰æ•°æ®å¤„ç†ã€ç‰¹å¾å·¥ç¨‹ã€æ‰¹æ¬¡è®¾ç½®ç­‰

experiment_name: vae_advanced_exp

task:
  # ========================================================================
  # 1. æ•°æ®é¢„å¤„ç†é…ç½® (DataProcessor)
  # ========================================================================
  preprocessor:
    class: DataPreprocessor
    module_path: quantclassic.data_processor.data_preprocessor
    kwargs:
      config:
        # ------------------------------------------------
        # å¤„ç†æµæ°´çº¿æ­¥éª¤ (æŒ‰é¡ºåºæ‰§è¡Œ)
        # ------------------------------------------------
        pipeline_steps:
          # æ­¥éª¤1: å¤„ç†æ— ç©·å€¼
          - name: "å¤„ç†æ— ç©·å€¼"
            method: "clip"
            features: null  # null è¡¨ç¤ºæ‰€æœ‰ç‰¹å¾åˆ—
            enabled: true
            params:
              lower: -1e10
              upper: 1e10
          
          # æ­¥éª¤2: å¡«å……ç¼ºå¤±å€¼
          - name: "å¡«å……ç¼ºå¤±å€¼"
            method: "fillna_median"  # å¯é€‰: fillna_mean, fillna_forward, fillna_zero
            features: null
            enabled: true
            params: {}
          
          # æ­¥éª¤3: å»æå€¼ (Winsorization)
          - name: "å»æå€¼"
            method: "winsorize"
            features: null
            enabled: true
            params:
              limits: [0.025, 0.025]  # ä¸Šä¸‹å„å»2.5%æå€¼
          
          # æ­¥éª¤4: åˆ†ç»„å¤„ç† - éƒ¨åˆ†ç‰¹å¾ç”¨ Z-Score
          - name: "ä»·æ ¼ç±»ç‰¹å¾æ ‡å‡†åŒ–"
            method: "z_score"
            features:  # æŒ‡å®šç‰¹å¾åˆ—è¡¨
              - "close"
              - "open"
              - "high"
              - "low"
              - "vwap"
            enabled: true
            params: {}
          
          # æ­¥éª¤5: åˆ†ç»„å¤„ç† - éƒ¨åˆ†ç‰¹å¾ç”¨ MinMax å½’ä¸€åŒ–
          - name: "æŠ€æœ¯æŒ‡æ ‡å½’ä¸€åŒ–"
            method: "minmax"
            features:
              - "rsi"
              - "kdj_k"
              - "kdj_d"
              - "cci"
              - "macd"
            enabled: true
            params:
              feature_range: [0, 1]  # å½’ä¸€åŒ–åˆ° [0, 1]
          
          # æ­¥éª¤6: åˆ†ç»„å¤„ç† - æˆäº¤é‡ç±»ç‰¹å¾ç”¨ç§©å½’ä¸€åŒ–
          - name: "æˆäº¤é‡ç±»ç§©å½’ä¸€åŒ–"
            method: "rank"
            features:
              - "volume"
              - "amount"
              - "turnover_rate"
            enabled: true
            params:
              output_range: [-1, 1]  # ç§©å½’ä¸€åŒ–åˆ° [-1, 1]
          
          # æ­¥éª¤7: å¸‚å€¼è¡Œä¸šä¸­æ€§åŒ– (å¯é€‰)
          - name: "å¸‚å€¼è¡Œä¸šä¸­æ€§åŒ–"
            method: "ols_neutralize"
            features: null  # å¯¹æ‰€æœ‰ç‰¹å¾è¿›è¡Œä¸­æ€§åŒ–
            enabled: false  # é»˜è®¤å…³é—­ï¼Œéœ€è¦æ—¶å¼€å¯
            params: {}
          
          # æ­¥éª¤8: SimStock ä¸­æ€§åŒ– (å¯é€‰)
          - name: "ç›¸ä¼¼è‚¡ç¥¨ä¸­æ€§åŒ–"
            method: "simstock_neutralize"
            features: null
            enabled: false  # é»˜è®¤å…³é—­
            params: {}
        
        # ------------------------------------------------
        # å­—æ®µæ˜ å°„ (é‡å‘½ååˆ—)
        # ------------------------------------------------
        column_mapping:
          ts_code: "order_book_id"
          trade_date: "datetime"
          # å¯æ·»åŠ æ›´å¤šæ˜ å°„...
        
        # ------------------------------------------------
        # åˆ†ç»„åˆ— (æŒ‰æ—¥æœŸåˆ†ç»„å¤„ç†)
        # ------------------------------------------------
        groupby_columns:
          - "trade_date"  # æŒ‰äº¤æ˜“æ—¥åˆ†ç»„è¿›è¡Œæ ‡å‡†åŒ–/å½’ä¸€åŒ–
        
        # ------------------------------------------------
        # IDåˆ— (ä¸å‚ä¸å¤„ç†)
        # ------------------------------------------------
        id_columns:
          - "ts_code"
          - "order_book_id"
          - "trade_date"
          - "datetime"
        
        # ------------------------------------------------
        # ä¸­æ€§åŒ–é…ç½®
        # ------------------------------------------------
        neutralize_config:
          # OLSä¸­æ€§åŒ–å‚æ•°
          industry_column: "industry_name"
          market_cap_column: "total_mv"
          min_samples: 10
          
          # SimStockä¸­æ€§åŒ–å‚æ•°
          target_column: "ret_1d"
          similarity_threshold: 0.7
          lookback_window: 252
          min_similar_stocks: 5
          correlation_method: "pearson"  # å¯é€‰: 'spearman'
        
        # ------------------------------------------------
        # å…¶ä»–é€‰é¡¹
        # ------------------------------------------------
        save_intermediate: false  # æ˜¯å¦ä¿å­˜ä¸­é—´ç»“æœ
        intermediate_dir: "output/intermediate"
        validate_each_step: true  # æ¯æ­¥åéªŒè¯æ•°æ®è´¨é‡
        verbose: true
  
  # ========================================================================
  # 2. æ•°æ®ç®¡ç†é…ç½® (DataManager)
  # ========================================================================
  dataset:
    class: DataManager
    module_path: quantclassic.data_set.manager
    kwargs:
      config:
        # ------------------------------------------------
        # æ•°æ®è·¯å¾„
        # ------------------------------------------------
        base_dir: "output"
        data_file: "train_data_final_01.parquet"
        output_dir: "output"
        cache_dir: "output/cache"
        
        # ------------------------------------------------
        # æ•°æ®å‚æ•°
        # ------------------------------------------------
        window_size: 40      # æ—¶é—´çª—å£å¤§å°
        batch_size: 512      # æ‰¹æ¬¡å¤§å° (å¯æ ¹æ®GPUå†…å­˜è°ƒæ•´)
        num_workers: 4       # DataLoaderå·¥ä½œè¿›ç¨‹æ•°
        
        # ------------------------------------------------
        # æ•°æ®åˆ’åˆ†ç­–ç•¥
        # ------------------------------------------------
        split_strategy: "time_series"  # æ—¶é—´åºåˆ—åˆ’åˆ†
        train_ratio: 0.6     # è®­ç»ƒé›†æ¯”ä¾‹
        val_ratio: 0.2       # éªŒè¯é›†æ¯”ä¾‹
        test_ratio: 0.2      # æµ‹è¯•é›†æ¯”ä¾‹
        
        # ------------------------------------------------
        # ç‰¹å¾é€‰æ‹©
        # ------------------------------------------------
        # æ–¹å¼1: è‡ªåŠ¨è¿‡æ»¤ä½è´¨é‡ç‰¹å¾
        auto_filter_features: true
        filter_config:
          na_threshold: 0.3        # ç¼ºå¤±å€¼æ¯”ä¾‹é˜ˆå€¼
          variance_threshold: 0.01  # æ–¹å·®é˜ˆå€¼
          correlation_threshold: 0.95  # ç›¸å…³æ€§é˜ˆå€¼
        
        # æ–¹å¼2: æ‰‹åŠ¨æŒ‡å®šç‰¹å¾åˆ— (ä¼˜å…ˆçº§æ›´é«˜)
        feature_columns: null  # null è¡¨ç¤ºä½¿ç”¨è‡ªåŠ¨è¿‡æ»¤
        # feature_columns:  # å–æ¶ˆæ³¨é‡Šä»¥æ‰‹åŠ¨æŒ‡å®š
        #   - "close"
        #   - "volume"
        #   - "rsi"
        #   - ...
        
        # ------------------------------------------------
        # å…¶ä»–é€‰é¡¹
        # ------------------------------------------------
        enable_validation: true
        save_data_report: true
        verbose: true
        log_level: "INFO"
        shuffle: true  # æ˜¯å¦æ‰“ä¹±è®­ç»ƒæ•°æ®
  
  # ========================================================================
  # 3. æ¨¡å‹é…ç½® (VAEModel)
  # ========================================================================
  model:
    class: VAE
    module_path: quantclassic.model.pytorch_models
    kwargs:
      # ------------------------------------------------
      # æ¨¡å‹æ¶æ„å‚æ•°
      # ------------------------------------------------
      d_feat: 20           # è¾“å…¥ç‰¹å¾ç»´åº¦ (è‡ªåŠ¨ä»æ•°æ®æ¨æ–­)
      hidden_dim: 128      # GRUéšè—å±‚ç»´åº¦
      latent_dim: 16       # æ½œåœ¨ç©ºé—´ç»´åº¦ (å› å­æ•°é‡)
      window_size: 40      # æ—¶é—´çª—å£ (éœ€ä¸ dataset.window_size ä¸€è‡´)
      dropout: 0.3         # Dropoutç‡
      num_layers: 2        # GRUå±‚æ•°
      
      # ------------------------------------------------
      # VAEæŸå¤±æƒé‡ (é‡è¦è¶…å‚æ•°!)
      # ------------------------------------------------
      alpha_recon: 0.1     # é‡æ„æŸå¤±æƒé‡
      beta_kl: 0.001       # KLæ•£åº¦æŸå¤±æƒé‡ (æ§åˆ¶æ­£åˆ™åŒ–å¼ºåº¦)
      gamma_pred: 1.0      # é¢„æµ‹æŸå¤±æƒé‡
      
      # ğŸ’¡ è°ƒå‚å»ºè®®:
      # - beta_kl è¶Šå¤§ï¼Œæ½œåœ¨ç©ºé—´è¶Šè§„åˆ™ï¼Œä½†é‡æ„è´¨é‡å¯èƒ½ä¸‹é™
      # - alpha_recon è¶Šå¤§ï¼Œé‡æ„è¶Šå¥½ï¼Œä½†å¯èƒ½è¿‡æ‹Ÿåˆ
      # - gamma_pred æ§åˆ¶é¢„æµ‹ä»»åŠ¡çš„é‡è¦æ€§
      
      # ------------------------------------------------
      # è®­ç»ƒå‚æ•°
      # ------------------------------------------------
      n_epochs: 100        # æœ€å¤§è®­ç»ƒè½®æ•°
      lr: 0.001            # åˆå§‹å­¦ä¹ ç‡
      early_stop: 15       # æ—©åœ patience
      batch_size: 512      # æ‰¹å¤§å° (éœ€ä¸ dataset.batch_size ä¸€è‡´)
      metric: "mse"        # ä¼˜åŒ–æŒ‡æ ‡
      
      # ------------------------------------------------
      # ä¼˜åŒ–å™¨é…ç½® (å¯é€‰)
      # ------------------------------------------------
      optimizer: "AdamW"   # å¯é€‰: Adam, AdamW, SGD
      optimizer_params:
        weight_decay: 1e-4
        betas: [0.9, 0.999]
      
      # ------------------------------------------------
      # å­¦ä¹ ç‡è°ƒåº¦å™¨ (å¯é€‰)
      # ------------------------------------------------
      scheduler: "ReduceLROnPlateau"  # å¯é€‰: StepLR, CosineAnnealingLR
      scheduler_params:
        mode: "min"
        factor: 0.5
        patience: 5
        min_lr: 1e-6
      
      # ------------------------------------------------
      # è®¾å¤‡é…ç½®
      # ------------------------------------------------
      device: "cuda"  # å¯é€‰: cuda, cpu
      seed: 42        # éšæœºç§å­
  
  # ========================================================================
  # 4. å›æµ‹é…ç½® (FactorBacktestSystem)
  # ========================================================================
  backtest:
    class: FactorBacktestSystem
    module_path: quantclassic.backtest.backtest_system
    kwargs:
      config:
        # ------------------------------------------------
        # è¾“å‡ºè®¾ç½®
        # ------------------------------------------------
        output_dir: "output/vae_backtest"
        save_plots: true
        generate_excel: true
        
        # ------------------------------------------------
        # åˆ†ç»„å›æµ‹
        # ------------------------------------------------
        n_groups: 10  # åˆ†ç»„æ•°é‡ (10ç»„: ååˆ†ä½)
        
        # ------------------------------------------------
        # ICåˆ†æ
        # ------------------------------------------------
        ic_method: "spearman"  # å¯é€‰: pearson, spearman
        
        # ------------------------------------------------
        # å¤šç©ºç»„åˆ
        # ------------------------------------------------
        long_short:
          top_quantile: 0.1    # åšå¤šå‰10%
          bottom_quantile: 0.1  # åšç©ºå10%
          commission: 0.0003    # æ‰‹ç»­è´¹ç‡
        
        # ------------------------------------------------
        # å…¶ä»–
        # ------------------------------------------------
        device: "cuda"
        log_level: "INFO"
        console_log: true

# ========================================================================
# 5. å®éªŒç®¡ç†é…ç½® (å¯é€‰)
# ========================================================================
workflow:
  # å®éªŒè®°å½•ç›®å½•
  recorder_dir: "output/mlruns"
  
  # è‡ªåŠ¨è®°å½•å‚æ•°
  auto_log_params: true
  
  # è‡ªåŠ¨è®°å½•æŒ‡æ ‡
  auto_log_metrics: true
  
  # è‡ªåŠ¨ä¿å­˜æ¨¡å‹
  auto_save_model: true
  
  # å®éªŒæ ‡ç­¾
  tags:
    project: "vae_factor_mining"
    version: "v2.0"
    author: "quantclassic"

# ========================================================================
# ä½¿ç”¨è¯´æ˜
# ========================================================================
# 
# 1. åŸºæœ¬ç”¨æ³•:
#    python -m quantclassic.config.cli vae_advanced.yaml
# 
# 2. Pythonä»£ç ç”¨æ³•:
#    from quantclassic.config import ConfigLoader, TaskRunner
#    config = ConfigLoader.load('vae_advanced.yaml')
#    results = TaskRunner().run(config)
# 
# 3. è‡ªå®šä¹‰é¢„å¤„ç†:
#    - ä¿®æ”¹ preprocessor.pipeline_steps è°ƒæ•´å¤„ç†æµç¨‹
#    - é’ˆå¯¹ä¸åŒç‰¹å¾ç»„ä½¿ç”¨ä¸åŒçš„æ ‡å‡†åŒ–æ–¹æ³•
#    - å¯ç”¨/ç¦ç”¨ä¸­æ€§åŒ–æ­¥éª¤
# 
# 4. è‡ªå®šä¹‰æ•°æ®æ‰¹æ¬¡:
#    - ä¿®æ”¹ dataset.batch_size å’Œ model.batch_size (ä¿æŒä¸€è‡´)
#    - è°ƒæ•´ dataset.num_workers æ§åˆ¶æ•°æ®åŠ è½½é€Ÿåº¦
#    - ä¿®æ”¹ dataset.window_size å’Œ model.window_size (ä¿æŒä¸€è‡´)
# 
# 5. è‡ªå®šä¹‰ç‰¹å¾:
#    - æ–¹å¼1: è®¾ç½® auto_filter_features: true è‡ªåŠ¨ç­›é€‰
#    - æ–¹å¼2: æ‰‹åŠ¨æŒ‡å®š feature_columns åˆ—è¡¨
# 
# 6. è¶…å‚æ•°è°ƒä¼˜:
#    - VAEæŸå¤±æƒé‡: alpha_recon, beta_kl, gamma_pred
#    - æ¨¡å‹ç»“æ„: hidden_dim, latent_dim, num_layers
#    - è®­ç»ƒå‚æ•°: lr, batch_size, n_epochs
# 
# 7. é…ç½®å¤ç”¨:
#    - ä¿å­˜æ­¤æ–‡ä»¶ä¸ºæ¨¡æ¿
#    - å¤åˆ¶åä¿®æ”¹å…³é”®å‚æ•°
#    - ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶è¿½è¸ªé…ç½®å˜åŒ–
# 
# ========================================================================
